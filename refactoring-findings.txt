Circle Calendar - Refactoring Analysis
======================================
Generated: 2026-02-01

PROJECT OVERVIEW
----------------
Circle Calendar is a full-stack web application for creating and viewing events
on an interactive circular year calendar. Single-page application with Python
FastAPI backend and vanilla JavaScript frontend.

Technology Stack:
- Backend: FastAPI, SQLAlchemy, PostgreSQL, Uvicorn
- Frontend: Vanilla JavaScript, D3.js (v7), HTML5/CSS3
- Authentication: Google OAuth, JWT tokens
- Email: SendGrid
- Deployment: Railway (backend), Vercel (static files)

CURRENT CODE METRICS
--------------------
Backend: ~936 lines of Python across 11 files (well-organized)
Frontend: ~3,518 lines in single app.js file (monolithic)
CSS: ~1,170 lines in single style.css file
No build system, no minification, no bundling

HIGH-IMPACT REFACTORING ITEMS
-----------------------------

1. SPLIT app.js INTO MODULES
   Problem: 3,518 LOC in single IIFE makes debugging and maintenance difficult
   Solution: Break into logical modules:
   - calendar.js - Circle calendar rendering, SVG manipulation
   - events.js - Event CRUD, annotation management
   - friends.js - Friend system, invitations
   - auth.js - Authentication, user session
   - utils.js - Date utilities, constants, helpers
   - ui.js - Modal management, DOM interactions
   - state.js - Centralized state management
   - main.js - App initialization, event binding

2. ADD BUILD SYSTEM
   Problem: No minification, no tree-shaking, no module bundling
   Solution: Introduce Vite or esbuild
   Benefits:
   - Minification (60-70% size reduction)
   - ES module support
   - Hot module replacement for development
   - Tree-shaking unused code
   - Source maps for debugging

3. CONSOLIDATE STATE MANAGEMENT
   Problem: 3 sources of truth causing sync bugs
   - API responses (server)
   - In-memory `annotations` object (client)
   - localStorage (offline/logged-out users)
   Previous bug: Commit 838151c fixed "events saving only updating front-end"
   Solution: Single state manager with:
   - One authoritative state object
   - Clear sync strategy with API
   - localStorage as cache only
   - Event-driven updates

4. CACHE DOM QUERIES
   Problem: Repeated querySelectorAll calls on every interaction
   Duplicated queries found:
   - document.querySelectorAll('.color-option') - lines 1400, 1906, 1912
   - document.querySelectorAll('.visibility-btn') - lines 1406, 1918
   - document.querySelectorAll('.annotation-text') - lines 1540, 1746
   - document.querySelectorAll('.day-segment') - lines 1932, 1943
   Solution: Cache selectors at initialization, refresh only when DOM changes

5. EXTRACT DUPLICATE LOGIC
   Duplicated code patterns:

   a) Birthday validation:
      - api/profile.py lines 20-28 (server)
      - app.js lines 195-199 (client)
      - app.js lines 2732-2743 (UI handler)

   b) Color picker reset:
      - openEditModal() lines 1400-1407
      - Form initialization lines 1906-1920

   c) Day range highlighting:
      - highlightRange() line ~1940
      - updateDaySegmentHighlights() line 2261+
      - handleDayRangeMove() line ~1870

   d) Event data transformation:
      - Multiple conversions between API format and display format

   Solution: Extract into reusable utility functions

MEDIUM-IMPACT ITEMS
-------------------

6. REPLACE POLLING WITH SSE/WEBSOCKET
   Problem: Friends list polls every 30 seconds unconditionally (line 90)
   Solution: Server-Sent Events for push notifications

7. SPLIT style.css
   Problem: 1,170 LOC in single file
   Solution: Split into layout.css, calendar.css, modals.css, responsive.css

8. NORMALIZE ANNOTATION FORMAT
   Problem: Many `typeof annotation === 'object'` checks throughout code
   Solution: Standardize all annotations as objects, remove legacy string format

LOWER PRIORITY ITEMS
--------------------

9. ADD DATABASE INDEXES
   - user_id in events table
   - user_id and status in friendships table

10. ADD TEST COVERAGE
    - No tests currently exist
    - Priority: State management, date utilities, API endpoints

UNUSED/DEAD CODE PATTERNS
-------------------------
- labeler.js loaded but usage unclear
- Conditional function checks suggest injected code:
  - `if (typeof updateListView === 'function')`
  - `if (typeof clearListRangeHighlight === 'function')`
  - `if (typeof isListDragging !== 'undefined')`

DEPLOYMENT NOTES
----------------
- Backend: Railway (Procfile-based)
- Frontend: Vercel (static files)
- Database: PostgreSQL on Railway
- No build step currently - files uploaded directly
